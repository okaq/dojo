<!DOCTYPE html>
<html lang="en">
    <head id="zeta">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=1920,height=1080,initial-scale=1" />
        <meta name="source" content="https://github.com/okaq/akari" />
        <meta name="author" content="AQ<aq@okaq.com>" />
        <meta name="date" content="2019-04-18" />
        <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAMklEQVR4nGI5O/s/Ay0BE01NH7Vg1IJRC0YtGLVg1IJRC0YtGLVg1IJRC6gIAAEAAP//0iICqtEdyE8AAAAASUVORK5CYII=" />
        <style type="text/css">
            html,body{width:1920px;overflow:auto;height:1080px;margin:0px;border:0px;padding:0px;background-color:rgba(0,0,0,0);}
        </style>
        <!-- openType.js -->
        <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
        <script type="text/javascript">
            // ok
            console.log("okaq akari ok!");
            // async load
            (function() {
                var a = {
                    "load": function(e) {
                        console.log(e);
                        g.init();
                    }
                }
                document.addEventListener("DOMContentLoaded", a.load, false);
            })();
// game
var g = {
        "init": function() {
            var t0 = window.performance.now();
            console.log("start akari...");

            // subs
            g.subs = [dom,sce];
            g.subs.forEach(function(el){el.init();});

            // wait and begin
            // window.setTimeout(g.start, 1000);
            window.setTimeout(g.start, 1000);
        },
        "start": function() {
            // clear
            ren.bkgd();
            ren.pane();
            // net pid
            // async font load
            net.moji();

            // loop
            g.tick = 0;
            g.id = window.setInterval(g.frame, 1000);
        },
        "frame": function() {
            // tick test
            if (g.tick >= net.noto.numGlyphs) {
                console.log("anim done");
                window.clearInterval(g.id);
                return;
            }
            console.log("glyph # " + g.tick + " / " + net.noto.numGlyphs);
            console.log("glyph name = " + net.noto.glyphs.glyphs[g.tick].name);
            console.log("glyph code point: " + net.noto.glyphs.glyphs[g.tick].unicode);
            var s0 = String.fromCharCode(net.noto.glyphs.glyphs[g.tick].unicode);
            sce.b.t2 = s0;
            var s2 = net.noto.glyphs.glyphs[g.tick].unicode;
            // metrics
            var b0 = net.noto.glyphs.glyphs[g.tick].getBoundingBox();
            console.log(b0);
            // use measure text object to get scaled size
            // console.log(typeof(s2));
            // var s3 = String.fromCodePoint(s2);
            // console.log("\\u" + s2);
            // var s1 = String.fromCodePoint(parseInt(net.noto.glyphs.glyphs[g.tick].unicode));
            // sce.b.t3 = s1;
            var s3 = "";
            // 16-bit max 65535
            if (s2 >= 12600) {
                s3 = String.fromCodePoint(s2);
                sce.b.t2 = s3;
            }
            console.log(s3);
            console.log(s0);
            // increment code point index
            // render and sample glyph
            // begins glitch after 12953
            // code point 1042476
            ren.glyph();
            // sample pixel data
            sce.buff();
            g.tick = g.tick + 1;
        }
    }
// scene
var sce = {
    "init": function() {
        // bkgd
        sce.a = {};
        sce.a.r = [1920,1080,0,0];
        sce.a.c = dom.canvas(sce.a.r);
        dom.add(sce.a.c);
        // pane
        sce.b = {};
        sce.b.r = [512,512,734,284];
        sce.b.c = dom.canvas(sce.b.r);
        dom.add(sce.b.c);
    },
    "moji": function() {
        // unicode code points
        // '\u263A' = 'smileface'
        sce.b.t = '\u263A';
        ren.txt();
    },
    "buff": function() {
        // back buffer
        sce.c = {};
        sce.c.p = sce.b.c.con.getImageData(0,0,sce.b.c.can.width,sce.b.c.can.height);
        sce.c.t = sce.c.p.data;
        console.log(sce.c.t.length);
    }
}
// xhr
var net = {
    "moji": function() {
        window.fetch("/e")
            .then(resp => resp.arrayBuffer())
            .then(font => {
                const fontFace = new FontFace("Noto Emoji", font);
                document.fonts.add(fontFace);
                // document.body.style.fontFamily = '"Noto Emoji", Arial';
                document.body.style.fontFamily = "Noto Emoji";

                // opentype query
                net.noto = opentype.parse(font);
                console.log(net.noto);

                sce.moji();
            })
    }
}
// render
var ren = {
    "bkgd": function() {
        sce.a.c.con.fillStyle = rgba.css([0,0,0,1.0]);
        sce.a.c.con.fillRect(0,0,sce.a.c.can.width,sce.a.c.can.height);
    },
    "pane": function() {
        sce.b.c.con.fillStyle = rgba.css([255,255,255,1.0]);
        sce.b.c.con.fillRect(0,0,sce.b.c.can.width,sce.b.c.can.height);
    },
    "txt": function() {
        sce.b.c.con.fillStyle = rgba.css([0,0,0,1.0]);
        sce.b.c.con.font = '128px "Noto Emoji"';
        sce.b.c.con.fillText(sce.b.t, 32, 256);
    },
    "glyph": function() {
        // rng bkgd
        sce.a.c.con.fillStyle = rgba.rand();
        sce.a.c.con.fillRect(0,0,sce.a.c.can.width,sce.a.c.can.height);
        // rng pane
        sce.b.c.con.fillStyle = rgba.rand();
        sce.b.c.con.fillRect(0,0,sce.b.c.can.width,sce.b.c.can.height);
        // rng font
        sce.b.c.con.fillStyle = rgba.rand();
        sce.b.c.con.font = '400px "Noto Emoji"';
        // measurement to detrmine dynamic centering
        // var m0 = sce.b.c.con.measureText(sce.b.t2);
        // console.log(m0);
        // width = 507.8125, monospace
        sce.b.c.con.fillText(sce.b.t2, 2, 400);
    }
}
   // dom
   var dom = {
        "init": function() {
            dom.alpha = document.getElementById("alpha");
            console.log(dom.alpha);
        },
        "canvas": function(r0) {
            var c0 = {};
            c0.can = document.createElement("canvas");
            c0.con = c0.can.getContext("2d");
            c0.can.width = r0[0];
            c0.can.height = r0[1];
            c0.can.style.position = "absolute";
            c0.can.style.top = r0[3] + "px";
            c0.can.style.left = r0[2] + "px";
            return c0;
        },
        "canvas2": function(r0) {
            var c0 = {};
            c0.can = document.createElement("canvas");
            // c0.con = c0.can.getContext("2d");
            // let babylonjs create the wegbl context
            c0.can.width = r0[0];
            c0.can.height = r0[1];
            c0.can.style.position = "absolute";
            c0.can.style.top = r0[3] + "px";
            c0.can.style.left = r0[2] + "px";
            return c0;
        },
        "add": function(c0) {
            dom.alpha.appendChild(c0.can);
        },
        "remove": function(c0) {
            dom.alpha.removeChild(c0.can);
        }
    }
    // colors
    var rgba = {
        "rc": function() {
            // return random rgba
            var c0 = [
                rgba.rb(),
                rgba.rb(),
                rgba.rb(),
                1.0
                ];
            return c0;
        },
        "css": function(c0) {
            // return css string
            return "rgba(" + c0.join(",") + ")";
        },
        "rb": function() {
            // random byte
            return (Math.random() * 255) >>> 0;
        },
        "rba": function(size0) {
            // random byte array length of input
            var r0 = [];
            for (var i = 0; i < size0; i++) {
                r0.push(rgba.rb());
            }
            return r0;
        },
        "rand": function() {
            return rgba.css(rgba.rc());
        },
        "mono": function(c0) {
            return rgba.css([c0,c0,c0,1.0]);
        },
        "rmon": function() {
            var c0 = rgba.rb();
            return rgba.mono(c0);
        }
    }

</script>
        </head>
        <body id="alpha">
        </body>
    </html>

